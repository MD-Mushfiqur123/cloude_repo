<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Cloud - Enterprise Storage</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* =========================================
           1. CORE VARIABLES & RESET
           ========================================= */
        :root {
            --bg-body: #181818;
            --bg-sidebar: #202020;
            --bg-surface: #2b2b2b;
            --bg-hover: #383838;
            --primary: #4285f4;
            --primary-hover: #5294ff;
            --text-main: #e8eaed;
            --text-sub: #9aa0a6;
            --border: #3c4043;
            --danger: #ea4335;
            --success: #34a853;
            --warning: #fbbc04;
            --radius: 8px;
            --shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        * { box-sizing: border-box; outline: none; user-select: none; }
        body {
            margin: 0; padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* =========================================
           2. HEADER SECTION
           ========================================= */
        .header {
            height: 60px;
            background: var(--bg-sidebar);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }
        .logo { font-size: 22px; font-weight: bold; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
        .logo i { color: var(--primary); }
        
        .search-bar {
            background: var(--bg-surface);
            border-radius: 8px;
            padding: 8px 15px;
            width: 40%;
            display: flex;
            align-items: center;
            border: 1px solid transparent;
            transition: 0.3s;
        }
        .search-bar:focus-within { background: var(--bg-body); border-color: var(--primary); box-shadow: 0 1px 5px rgba(0,0,0,0.5); }
        .search-bar input {
            background: transparent; border: none; color: white; width: 100%; margin-left: 10px; font-size: 16px;
        }

        .header-actions { display: flex; gap: 15px; }
        .icon-btn {
            background: transparent; border: none; color: var(--text-sub); font-size: 18px; cursor: pointer;
            padding: 8px; border-radius: 50%; transition: 0.2s;
        }
        .icon-btn:hover { background: var(--bg-hover); color: var(--text-main); }

        /* =========================================
           3. MAIN LAYOUT (SIDEBAR + CONTENT)
           ========================================= */
        .main-container { display: flex; flex: 1; overflow: hidden; }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: var(--bg-sidebar);
            padding: 20px 10px;
            display: flex;
            flex-direction: column;
        }
        .new-btn {
            background: var(--bg-surface);
            color: var(--primary);
            border-radius: 24px;
            padding: 12px 24px;
            font-weight: bold;
            box-shadow: var(--shadow);
            cursor: pointer;
            border: 1px solid var(--border);
            display: flex; align-items: center; gap: 10px;
            transition: 0.2s;
            margin-bottom: 20px;
        }
        .new-btn:hover { background: var(--bg-hover); }
        
        .nav-item {
            padding: 10px 20px;
            border-radius: 0 20px 20px 0;
            color: var(--text-sub);
            cursor: pointer;
            display: flex; align-items: center; gap: 15px;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .nav-item:hover { background: var(--bg-hover); color: var(--text-main); }
        .nav-item.active { background: #4285f433; color: var(--primary); }

        .storage-info { margin-top: auto; padding: 15px; color: var(--text-sub); font-size: 12px; }
        .progress-track { height: 4px; background: var(--bg-hover); margin: 10px 0; border-radius: 2px; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; border-radius: 2px; }

        /* Content Area */
        .content-area { flex: 1; background: var(--bg-body); padding: 20px; overflow-y: auto; position: relative; }
        
        .breadcrumb { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; font-size: 18px; color: var(--text-sub); }
        .breadcrumb span { cursor: pointer; transition: 0.2s; }
        .breadcrumb span:hover { color: var(--text-main); }
        .breadcrumb .current { color: var(--text-main); font-weight: 500; }

        /* Grid View */
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        .file-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 15px;
            cursor: pointer;
            transition: 0.2s;
            display: flex; flex-direction: column; align-items: center;
            position: relative;
        }
        .file-card:hover { background: var(--bg-hover); border-color: var(--text-sub); }
        .file-card.selected { background: #4285f433; border-color: var(--primary); }
        
        .file-icon { font-size: 40px; margin-bottom: 15px; color: var(--text-sub); }
        .folder-icon { color: var(--text-sub); }
        .file-name { font-size: 14px; text-align: center; word-break: break-all; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }

        /* Details Panel */
        .details-panel {
            width: 300px;
            background: var(--bg-sidebar);
            border-left: 1px solid var(--border);
            padding: 20px;
            display: none; /* Hidden by default */
            flex-direction: column;
        }
        .details-panel.open { display: flex; }
        .preview-box { width: 100%; height: 150px; background: var(--bg-body); border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; font-size: 50px; color: var(--text-sub); }
        .detail-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 15px; color: var(--text-sub); border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        .detail-value { color: var(--text-main); }

        /* =========================================
           4. MODALS & CONTEXT MENU
           ========================================= */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 1000;
            display: none; justify-content: center; align-items: center;
        }
        .modal { background: var(--bg-surface); width: 400px; padding: 25px; border-radius: var(--radius); box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .modal h3 { margin-top: 0; }
        .modal input { width: 100%; padding: 10px; background: var(--bg-body); border: 1px solid var(--border); color: white; border-radius: 4px; margin: 10px 0; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; }
        .btn-cancel { background: transparent; color: var(--text-main); }
        .btn-primary { background: var(--primary); color: white; }

        .context-menu {
            position: absolute; background: var(--bg-surface); border: 1px solid var(--border);
            width: 200px; border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: none; z-index: 999; flex-direction: column; padding: 5px 0;
        }
        .ctx-item { padding: 10px 20px; cursor: pointer; display: flex; gap: 10px; align-items: center; color: var(--text-main); font-size: 14px; }
        .ctx-item:hover { background: var(--bg-hover); }
        .ctx-divider { height: 1px; background: var(--border); margin: 5px 0; }
        .ctx-danger { color: var(--danger); }

        /* Upload Progress */
        .upload-manager {
            position: fixed; bottom: 20px; right: 20px; width: 350px;
            background: var(--bg-surface); border-radius: var(--radius);
            box-shadow: 0 5px 20px rgba(0,0,0,0.6); display: none;
        }
        .um-header { background: #333; padding: 10px 15px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .um-body { max-height: 200px; overflow-y: auto; padding: 10px; }
        .upload-item { margin-bottom: 10px; font-size: 13px; }
        .up-progress { height: 4px; background: #444; margin-top: 5px; border-radius: 2px; }
        .up-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.2s; }

    </style>
</head>
<body>

    <div class="context-menu" id="ctxMenu">
        <div class="ctx-item" onclick="actions.preview()"><i class="fas fa-eye"></i> Preview</div>
        <div class="ctx-item" onclick="actions.download()"><i class="fas fa-download"></i> Download</div>
        <div class="ctx-item" onclick="actions.rename()"><i class="fas fa-pen"></i> Rename</div>
        <div class="ctx-divider"></div>
        <div class="ctx-item ctx-danger" onclick="actions.delete()"><i class="fas fa-trash"></i> Delete</div>
    </div>

    <header class="header">
        <div class="logo"><i class="fab fa-google-drive"></i> Nexus Cloud</div>
        <div class="search-bar">
            <i class="fas fa-search" style="color: #9aa0a6;"></i>
            <input type="text" id="searchInput" placeholder="Search in Drive">
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="sys.toggleSettings()"><i class="fas fa-cog"></i></button>
            <button class="icon-btn"><i class="fas fa-user-circle"></i></button>
        </div>
    </header>

    <div class="main-container">
        <aside class="sidebar">
            <button class="new-btn" onclick="sys.openUploadModal()">
                <i class="fas fa-plus"></i> New
            </button>
            
            <div class="nav-item active" onclick="ui.navigate('root')"><i class="fas fa-hdd"></i> My Drive</div>
            <div class="nav-item"><i class="fas fa-user-friends"></i> Shared</div>
            <div class="nav-item"><i class="fas fa-clock"></i> Recent</div>
            <div class="nav-item"><i class="fas fa-star"></i> Starred</div>
            <div class="nav-item"><i class="fas fa-trash-alt"></i> Trash</div>

            <div class="storage-info">
                <div>Storage (Simulated)</div>
                <div class="progress-track"><div class="progress-fill" style="width: 45%"></div></div>
                <div>6.4 GB of 15 GB used</div>
            </div>
        </aside>

        <main class="content-area" id="dropZone">
            <div class="breadcrumb" id="breadcrumb">
                <span class="current">My Drive</span>
            </div>
            
            <div class="file-grid" id="fileGrid">
                <div style="grid-column: 1/-1; text-align: center; margin-top: 50px; color: #555;">
                    <i class="fas fa-spinner fa-spin fa-3x"></i><br><br>Loading System...
                </div>
            </div>
        </main>

        <aside class="details-panel" id="detailsPanel">
            <div class="header" style="background:transparent; padding:0; height:auto; margin-bottom:20px; justify-content:space-between;">
                <strong>Details</strong>
                <i class="fas fa-times" style="cursor:pointer;" onclick="ui.closeDetails()"></i>
            </div>
            <div class="preview-box" id="detIcon"><i class="fas fa-file"></i></div>
            <div class="detail-row"><span>Name</span><span class="detail-value" id="detName">-</span></div>
            <div class="detail-row"><span>Type</span><span class="detail-value" id="detType">-</span></div>
            <div class="detail-row"><span>Size</span><span class="detail-value" id="detSize">-</span></div>
            <div class="detail-row"><span>Created</span><span class="detail-value" id="detDate">-</span></div>
        </aside>
    </div>

    <div class="upload-manager" id="uploadManager">
        <div class="um-header">
            <span>Uploading...</span>
            <i class="fas fa-times" style="cursor:pointer" onclick="document.getElementById('uploadManager').style.display='none'"></i>
        </div>
        <div class="um-body" id="uploadList"></div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <h3>⚙️ System Configuration</h3>
            <label>GitHub Personal Access Token (Repo Scope)</label>
            <input type="password" id="cfgToken">
            <label>Repository (user/repo)</label>
            <input type="text" id="cfgRepo">
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="sys.closeSettings()">Cancel</button>
                <button class="btn btn-primary" onclick="sys.saveSettings()">Save & Connect</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="folderModal">
        <div class="modal">
            <h3>New Folder</h3>
            <input type="text" id="newFolderName" placeholder="Untitled folder">
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="document.getElementById('folderModal').style.display='none'">Cancel</button>
                <button class="btn btn-primary" onclick="actions.createFolder()">Create</button>
            </div>
        </div>
    </div>

    <script>
        /* =========================================
           5. SYSTEM ARCHITECTURE & STATE
           ========================================= */
        const APP = {
            token: localStorage.getItem('nx_token') || '',
            repo: localStorage.getItem('nx_repo') || '',
            branch: 'main',
            rootIndex: 'nexus_system.json',
            currentPath: 'root', // ID of current folder
            fileSystem: {
                'root': { id: 'root', name: 'My Drive', type: 'folder', parent: null, children: [] }
            },
            selectedItem: null,
            uploadQueue: []
        };

        const CONFIG = {
            CHUNK_SIZE: 40 * 1024 * 1024, // 40MB Chunks
        };

        /* =========================================
           6. API LAYER (GITHUB INTERFACE)
           ========================================= */
        const api = {
            getHeaders: () => ({
                "Authorization": `token ${APP.token}`,
                "Accept": "application/vnd.github.v3+json",
                "Content-Type": "application/json"
            }),

            async getFile(path) {
                const url = `https://api.github.com/repos/${APP.repo}/contents/${path}?ref=${APP.branch}&t=${Date.now()}`;
                const res = await fetch(url, { headers: api.getHeaders() });
                if (!res.ok) return null;
                const data = await res.json();
                return JSON.parse(atob(data.content));
            },

            async uploadFile(path, content, msg) {
                const url = `https://api.github.com/repos/${APP.repo}/contents/${path}`;
                // Check if exists to get SHA
                let sha = null;
                try {
                    const check = await fetch(url, { headers: api.getHeaders() });
                    if (check.ok) sha = (await check.json()).sha;
                } catch(e) {}

                const body = { message: msg, content: content, branch: APP.branch };
                if (sha) body.sha = sha;

                const res = await fetch(url, {
                    method: 'PUT',
                    headers: api.getHeaders(),
                    body: JSON.stringify(body)
                });
                if (!res.ok) throw new Error(await res.text());
                return await res.json();
            },

            async deleteFile(path, sha) {
                const url = `https://api.github.com/repos/${APP.repo}/contents/${path}`;
                const body = { message: "Delete file", sha: sha, branch: APP.branch };
                await fetch(url, {
                    method: 'DELETE',
                    headers: api.getHeaders(),
                    body: JSON.stringify(body)
                });
            }
        };

        /* =========================================
           7. FILESYSTEM LOGIC (VIRTUAL DRIVE)
           ========================================= */
        const fs = {
            async init() {
                if (!APP.token || !APP.repo) {
                    sys.toggleSettings();
                    return;
                }
                
                // Try to load system index
                ui.showLoading();
                const remoteFS = await api.getFile(APP.rootIndex);
                if (remoteFS) {
                    APP.fileSystem = remoteFS;
                    console.log("FS Loaded:", APP.fileSystem);
                } else {
                    console.log("No FS found, creating new...");
                    await fs.sync();
                }
                ui.render(APP.currentPath);
            },

            async sync() {
                // Save current fileSystem state to GitHub
                const content = btoa(JSON.stringify(APP.fileSystem));
                await api.uploadFile(APP.rootIndex, content, "System Sync");
            },

            createNode(name, type, parentId, meta = {}) {
                const id = 'node_' + Date.now() + Math.random().toString(36).substr(2, 5);
                APP.fileSystem[id] = {
                    id, name, type, parent: parentId,
                    created: new Date().toISOString(),
                    ...meta
                };
                APP.fileSystem[parentId].children.push(id);
                return id;
            }
        };

        /* =========================================
           8. UI CONTROLLER
           ========================================= */
        const ui = {
            showLoading: () => {
                document.getElementById('fileGrid').innerHTML = '<div style="color:white; grid-column:1/-1; text-align:center">Loading...</div>';
            },

            render: (folderId) => {
                const grid = document.getElementById('fileGrid');
                grid.innerHTML = '';
                APP.currentPath = folderId;
                
                // Update Breadcrumb
                ui.updateBreadcrumb(folderId);

                const folder = APP.fileSystem[folderId];
                if (!folder || folder.children.length === 0) {
                    grid.innerHTML = '<div style="color:#555; grid-column:1/-1; text-align:center; margin-top:50px;">Empty Folder<br>Right click or Drop files</div>';
                    return;
                }

                folder.children.forEach(childId => {
                    const item = APP.fileSystem[childId];
                    if(!item) return; // Ghost node check

                    const el = document.createElement('div');
                    el.className = 'file-card';
                    el.onclick = (e) => ui.selectItem(e, item);
                    el.ondblclick = () => ui.openItem(item);
                    el.oncontextmenu = (e) => ui.showContext(e, item);

                    let icon = item.type === 'folder' ? 'fa-folder' : 'fa-file-alt';
                    let color = item.type === 'folder' ? '#9aa0a6' : '#4285f4';
                    
                    if(item.name.endsWith('.png') || item.name.endsWith('.jpg')) { icon = 'fa-image'; color = '#ea4335'; }
                    if(item.name.endsWith('.pdf')) { icon = 'fa-file-pdf'; color = '#ea4335'; }
                    if(item.name.endsWith('.zip')) { icon = 'fa-file-archive'; color = '#fbbc04'; }

                    el.innerHTML = `
                        <i class="fas ${icon} file-icon" style="color:${color}"></i>
                        <div class="file-name">${item.name}</div>
                    `;
                    grid.appendChild(el);
                });
            },

            updateBreadcrumb: (id) => {
                const bc = document.getElementById('breadcrumb');
                bc.innerHTML = '';
                
                const path = [];
                let curr = APP.fileSystem[id];
                while(curr) {
                    path.unshift(curr);
                    curr = APP.fileSystem[curr.parent];
                }

                path.forEach((node, index) => {
                    const span = document.createElement('span');
                    span.innerText = node.name;
                    span.onclick = () => ui.render(node.id);
                    if (index === path.length - 1) span.className = 'current';
                    bc.appendChild(span);
                    if (index < path.length - 1) bc.innerHTML += ' <i class="fas fa-chevron-right" style="font-size:12px"></i> ';
                });
            },

            selectItem: (e, item) => {
                e.stopPropagation();
                document.querySelectorAll('.file-card').forEach(el => el.classList.remove('selected'));
                e.currentTarget.classList.add('selected');
                APP.selectedItem = item;
                
                // Show Details
                const panel = document.getElementById('detailsPanel');
                panel.classList.add('open');
                document.getElementById('detName').innerText = item.name;
                document.getElementById('detType').innerText = item.type;
                document.getElementById('detSize').innerText = item.size ? ui.formatBytes(item.size) : '-';
                document.getElementById('detDate').innerText = new Date(item.created).toLocaleDateString();
            },

            closeDetails: () => {
                document.getElementById('detailsPanel').classList.remove('open');
            },

            openItem: (item) => {
                if (item.type === 'folder') {
                    ui.render(item.id);
                } else {
                    actions.preview();
                }
            },

            showContext: (e, item) => {
                e.preventDefault();
                ui.selectItem(e, item);
                const menu = document.getElementById('ctxMenu');
                menu.style.display = 'flex';
                menu.style.left = e.pageX + 'px';
                menu.style.top = e.pageY + 'px';
            },

            formatBytes: (bytes) => {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            },

            hideContext: () => {
                document.getElementById('ctxMenu').style.display = 'none';
            },
            
            navigate: (id) => ui.render(id)
        };

        /* =========================================
           9. SYSTEM ACTIONS
           ========================================= */
        const actions = {
            createFolder: async () => {
                const name = document.getElementById('newFolderName').value;
                if (!name) return;
                
                fs.createNode(name, 'folder', APP.currentPath);
                document.getElementById('folderModal').style.display = 'none';
                ui.render(APP.currentPath);
                await fs.sync();
            },

            delete: async () => {
                if(!APP.selectedItem) return;
                if(!confirm(`Delete ${APP.selectedItem.name}?`)) return;

                const parent = APP.fileSystem[APP.selectedItem.parent];
                // Remove from parent children list
                parent.children = parent.children.filter(id => id !== APP.selectedItem.id);
                
                // Remove from FS map
                delete APP.fileSystem[APP.selectedItem.id];
                
                // TODO: Actual API delete logic for files (complex due to chunks)
                
                ui.render(APP.currentPath);
                await fs.sync();
            },

            download: async () => {
                const item = APP.selectedItem;
                if(item.type === 'folder') return alert("Cannot download folders yet.");
                
                alert(`Downloading ${item.name}... Please wait.`);
                // Logic to fetch chunks and merge
                const chunks = [];
                for(let i=0; i<item.chunks; i++) {
                    const url = `https://api.github.com/repos/${APP.repo}/contents/${item.storePath}/part_${i}?ref=${APP.branch}`;
                    const res = await fetch(url, { headers: api.getHeaders() });
                    const json = await res.json();
                    
                    // Decode
                    const binStr = atob(json.content.replace(/\n/g, ''));
                    const len = binStr.length;
                    const bytes = new Uint8Array(len);
                    for (let k = 0; k < len; k++) bytes[k] = binStr.charCodeAt(k);
                    chunks.push(bytes);
                }

                const blob = new Blob(chunks, {type: item.mime});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = item.name;
                link.click();
            },
            
            preview: () => {
                alert("Preview functionality requires a backend proxy for secure viewing. Download to view.");
            },
            
            rename: async () => {
                const newName = prompt("Enter new name:", APP.selectedItem.name);
                if(newName) {
                    APP.selectedItem.name = newName;
                    ui.render(APP.currentPath);
                    await fs.sync();
                }
            }
        };

        /* =========================================
           10. UPLOAD ENGINE (SPLIT LOGIC)
           ========================================= */
        const uploader = {
            process: async (files) => {
                document.getElementById('uploadManager').style.display = 'block';
                
                for (let file of files) {
                    // Create UI element
                    const upId = 'up_' + Date.now();
                    const div = document.createElement('div');
                    div.className = 'upload-item';
                    div.innerHTML = `
                        <div>Uploading ${file.name}</div>
                        <div class="up-progress"><div class="up-fill" id="${upId}"></div></div>
                    `;
                    document.getElementById('uploadList').appendChild(div);

                    // Split logic
                    const totalChunks = Math.ceil(file.size / CONFIG.CHUNK_SIZE);
                    const storeFolder = `storage/${Date.now()}_${file.name.replace(/\W/g, '')}`;
                    
                    try {
                        for(let i=0; i<totalChunks; i++) {
                            const start = i * CONFIG.CHUNK_SIZE;
                            const end = Math.min(start + CONFIG.CHUNK_SIZE, file.size);
                            const chunk = file.slice(start, end);
                            
                            const reader = new FileReader();
                            const base64Promise = new Promise(resolve => {
                                reader.onload = e => resolve(e.target.result.split(',')[1]);
                                reader.readAsDataURL(chunk);
                            });
                            
                            const content = await base64Promise;
                            await api.uploadFile(`${storeFolder}/part_${i}`, content, `Part ${i}`);
                            
                            // Update progress
                            document.getElementById(upId).style.width = ((i+1)/totalChunks*100) + '%';
                        }

                        // Register in FS
                        fs.createNode(file.name, 'file', APP.currentPath, {
                            size: file.size,
                            mime: file.type,
                            chunks: totalChunks,
                            storePath: storeFolder
                        });
                        
                        await fs.sync();
                        ui.render(APP.currentPath);

                    } catch(e) {
                        console.error(e);
                        div.style.color = 'red';
                        div.innerText = `Error: ${file.name}`;
                    }
                }
            }
        };

        /* =========================================
           11. SYSTEM UTILS (SETTINGS & EVENTS)
           ========================================= */
        const sys = {
            toggleSettings: () => {
                const modal = document.getElementById('settingsModal');
                modal.style.display = 'flex';
                document.getElementById('cfgToken').value = APP.token;
                document.getElementById('cfgRepo').value = APP.repo;
            },
            closeSettings: () => document.getElementById('settingsModal').style.display = 'none',
            saveSettings: () => {
                const t = document.getElementById('cfgToken').value;
                const r = document.getElementById('cfgRepo').value;
                localStorage.setItem('nx_token', t);
                localStorage.setItem('nx_repo', r);
                APP.token = t;
                APP.repo = r;
                location.reload();
            },
            openUploadModal: () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.multiple = true;
                input.onchange = e => uploader.process(e.target.files);
                input.click();
            }
        };

        // Global Events
        document.onclick = () => {
            ui.hideContext();
            document.querySelectorAll('.file-card').forEach(e => e.classList.remove('selected'));
            ui.closeDetails();
        };

        // Context Menu Right Click
        document.getElementById('fileGrid').oncontextmenu = (e) => {
            if(e.target === document.getElementById('fileGrid')) {
                e.preventDefault();
                // Show general menu (New Folder)
                const menu = document.getElementById('ctxMenu');
                menu.innerHTML = `<div class="ctx-item" onclick="document.getElementById('folderModal').style.display='flex'"><i class="fas fa-folder-plus"></i> New Folder</div>`;
                menu.style.display = 'flex';
                menu.style.left = e.pageX + 'px';
                menu.style.top = e.pageY + 'px';
            }
        };

        // Drag and Drop
        const dz = document.getElementById('dropZone');
        dz.ondragover = e => { e.preventDefault(); dz.style.background = '#333'; };
        dz.ondragleave = e => { e.preventDefault(); dz.style.background = 'var(--bg-body)'; };
        dz.ondrop = e => {
            e.preventDefault();
            dz.style.background = 'var(--bg-body)';
            if(e.dataTransfer.files.length > 0) uploader.process(e.dataTransfer.files);
        };

        // Search
        document.getElementById('searchInput').oninput = (e) => {
            const val = e.target.value.toLowerCase();
            if(!val) return ui.render(APP.currentPath);
            
            const grid = document.getElementById('fileGrid');
            grid.innerHTML = '';
            
            // Search entire FS
            Object.values(APP.fileSystem).forEach(item => {
                if(item.name && item.name.toLowerCase().includes(val) && item.type !== 'root') {
                    // Render item (reuse logic simplified)
                    const el = document.createElement('div');
                    el.className = 'file-card';
                    el.innerHTML = `<i class="fas fa-search"></i><div class="file-name">${item.name}</div>`;
                    el.onclick = () => {
                        if(item.type==='folder') ui.render(item.id);
                        else { APP.selectedItem=item; actions.download(); }
                    };
                    grid.appendChild(el);
                }
            });
        };

        // Start App
        fs.init();

    </script>
</body>
</html>
